{% extends 'base.html' %}
{% load static %}

{% block title %}
{% if object %}Edit{% else %}Create{% endif %} Quotation Template
{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #667eea;
        --primary-dark: #764ba2;
        --success: #10b981;
        --danger: #dc2626;
        --secondary: #6b7280;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border-radius: 1rem;
        padding: 1.5rem;
    }

    .accent {
        background: rgba(102, 126, 234, 0.05);
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-[var(--primary)] to-[var(--primary-dark)] py-6 px-4">
    <div class="max-w-7xl mx-auto">

        <!-- Header -->
        <div class="glass-card mb-6 text-white">
            <div class="flex justify-between items-center flex-wrap gap-4">
                <div>
                    <h1 class="text-3xl font-bold flex items-center gap-2">
                        Create Template
                    </h1>
                    <p class="opacity-90 mt-1">Create a new reusable quotation template</p>
                </div>
                <a href="{% url 'quotation_template_list' %}"
                    class="bg-white/10 border border-white/20 px-4 py-2 rounded-lg hover:bg-white/20 transition">Back
                    to Templates</a>
            </div>
        </div>

        <form method="POST" id="quotationForm" class="space-y-6">
            {% csrf_token %}

            <!-- Template Information -->
            <div class="bg-white rounded-2xl shadow-md">
                <div
                    class="bg-gradient-to-r from-[var(--primary)] to-[var(--primary-dark)] text-white px-6 py-4 rounded-t-2xl">
                    <h2 class="text-lg font-semibold">Template Information</h2>
                </div>
                <div class="p-6 space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium">Template Name *</label>
                            <input type="text" name="name" id="templateName" class="w-full border rounded-md px-3 py-2"
                                placeholder="e.g., Standard Bathroom Renovation" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Project Type *</label>
                            <select name="projectType" id="projectType" class="w-full border rounded-md px-3 py-2"
                                required>
                                <option value="">Select type</option>
                                <option>Bathroom</option>
                                <option>Kitchen</option>
                                <option>General Renovation</option>
                                <option>Outdoor</option>
                                <option>Custom</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium">Description</label>
                        <textarea name="description" id="description" rows="3"
                            class="w-full border rounded-md px-3 py-2"
                            placeholder="Describe what this template includes..."></textarea>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium">Default Labor Cost (R)</label>
                            <input type="number" id="laborCost" name="defaultLaborCost" min="0" step="0.01"
                                placeholder="0.00" class="w-full border rounded-md px-3 py-2" value="0.00">
                        </div>
                        <div>
                            <label class="block text-sm font-medium">Default Transport Cost (R)</label>
                            <input type="number" id="transportCost" name="defaultTransportCost" min="0" step="0.01"
                                placeholder="0.00" class="w-full border rounded-md px-3 py-2" value="0.00">
                        </div>
                    </div>

                    <div class="flex items-center space-x-2">
                        <input type="checkbox" name="isActive" id="isActive" checked>
                        <label for="isActive" class="text-sm cursor-pointer">Active (available for use)</label>
                    </div>
                </div>
            </div>

            <!-- Template Items -->
            <div class="bg-white rounded-2xl shadow-md">
                <div class="bg-green-600 text-white px-6 py-4 rounded-t-2xl flex justify-between items-center">
                    <h2 class="text-lg font-semibold">Template Items</h2>
                    <button type="button" id="addRow"
                        class="bg-white text-green-700 px-3 py-1.5 rounded-md font-semibold hover:bg-green-100 transition">
                        + Add Item
                    </button>
                </div>
                <div class="p-6 overflow-x-auto">
                    <table class="w-full table-auto text-sm" id="itemTable">
                        <thead>
                            <tr class="border-b font-semibold">
                                <th>#</th>
                                <th>Description *</th>
                                <th>Qty *</th>
                                <th>Unit Price *</th>
                                <th>Category</th>
                                <th>Line Total</th>
                                <th>Optional</th>
                                <th>Delete</th>
                            </tr>
                        </thead>
                        <tbody id="itemBody">
                            <tr>
                                <td class="text-center index">1</td>
                                <td><input type="text" name="description_1"
                                        class="w-full border rounded-md px-2 py-1 item-description"></td>
                                <td><input type="number" min="1" step="1" value="1"
                                        class="w-full border rounded-md px-2 py-1 item-qty"></td>
                                <td><input type="number" min="0" step="0.01" placeholder="0.00"
                                        class="w-full border rounded-md px-2 py-1 item-price"></td>
                                <td>
                                    <select class="border rounded-md px-2 py-1 item-category">
                                        <option>Materials</option>
                                        <option>Labor</option>
                                        <option>Equipment</option>
                                        <option>Other</option>
                                    </select>
                                </td>
                                <td class="text-center line-total">R 0.00</td>
                                <td class="text-center">
                                    <input type="checkbox" class="item-optional">
                                </td>
                                <td class="text-center">
                                    <button type="button" class="text-red-600 font-bold deleteRow">×</button>
                                </td>
                            </tr>
                        </tbody>
                        <tfoot class="font-semibold">
                            <tr class="border-t">
                                <td colspan="5" class="text-right pr-2">Items Subtotal:</td>
                                <td id="subtotal" class="text-center">R 0.00</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-right pr-2">Labor Cost:</td>
                                <td id="laborDisplay" class="text-center">R 0.00</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-right pr-2">Transport Cost:</td>
                                <td id="transportDisplay" class="text-center">R 0.00</td>
                            </tr>
                            <tr class="bg-green-100 text-green-700">
                                <td colspan="5" class="text-right pr-2 text-lg">Estimated Total:</td>
                                <td id="grandTotal" class="text-center text-lg">R 0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="bg-white rounded-2xl shadow-md p-6 flex justify-between">
                <button type="button" onclick="window.history.back()"
                    class="px-4 py-2 border rounded-md">Cancel</button>
                <button type="submit"
                    class="px-6 py-2 bg-[var(--primary)] text-white rounded-md hover:bg-[var(--primary-dark)]">Save
                    Template</button>
            </div>
        </form>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const tableBody = document.getElementById("itemBody");
        const addRowBtn = document.getElementById("addRow");
        const laborInput = document.getElementById("laborCost");
        const transportInput = document.getElementById("transportCost");

        function updateTotals() {
            let subtotal = 0;
            document.querySelectorAll("#itemBody tr").forEach(row => {
                const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
                const price = parseFloat(row.querySelector(".item-price").value) || 0;
                const total = qty * price;
                row.querySelector(".line-total").textContent = "R " + total.toFixed(2);
                subtotal += total;
            });
            const labor = parseFloat(laborInput.value) || 0;
            const transport = parseFloat(transportInput.value) || 0;
            document.getElementById("subtotal").textContent = "R " + subtotal.toFixed(2);
            document.getElementById("laborDisplay").textContent = "R " + labor.toFixed(2);
            document.getElementById("transportDisplay").textContent = "R " + transport.toFixed(2);
            document.getElementById("grandTotal").textContent = "R " + (subtotal + labor + transport).toFixed(2);
        }

        function autoAddRow() {
            const allFilled = [...tableBody.querySelectorAll("tr")].every(row => {
                const desc = row.querySelector(".item-description").value.trim();
                const qty = parseFloat(row.querySelector(".item-qty").value);
                const price = parseFloat(row.querySelector(".item-price").value);
                return desc && qty > 0 && price > 0;
            });

            if (allFilled && tableBody.children.length < 50) {
                addRow();
            }
        }

        function addRow() {
            const rowCount = tableBody.children.length + 1;
            const row = document.createElement("tr");
            row.innerHTML = `
            <td class="text-center index">${rowCount}</td>
            <td><input type="text" class="w-full border rounded-md px-2 py-1 item-description"></td>
            <td><input type="number" min="1" step="1" value="1" class="w-full border rounded-md px-2 py-1 item-qty"></td>
            <td><input type="number" min="0" step="0.01" placeholder="0.00" class="w-full border rounded-md px-2 py-1 item-price"></td>
            <td>
                <select class="border rounded-md px-2 py-1 item-category">
                    <option>Materials</option>
                    <option>Labor</option>
                    <option>Equipment</option>
                    <option>Other</option>
                </select>
            </td>
            <td class="text-center line-total">R 0.00</td>
            <td class="text-center"><input type="checkbox" class="item-optional"></td>
            <td class="text-center"><button type="button" class="text-red-600 font-bold deleteRow">×</button></td>
        `;
            tableBody.appendChild(row);
        }

        function updateIndexes() {
            tableBody.querySelectorAll(".index").forEach((el, i) => el.textContent = i + 1);
        }

        tableBody.addEventListener("input", e => {
            if (e.target.matches(".item-description, .item-qty, .item-price")) {
                updateTotals();
                autoAddRow();
            }
        });

        tableBody.addEventListener("click", e => {
            if (e.target.classList.contains("deleteRow")) {
                if (tableBody.children.length > 1) {
                    e.target.closest("tr").remove();
                    updateIndexes();
                    updateTotals();
                } else {
                    alert("You need at least one item in your template.");
                }
            }
        });

        addRowBtn.addEventListener("click", addRow);
        laborInput.addEventListener("input", updateTotals);
        transportInput.addEventListener("input", updateTotals);
    });
</script>
{% endblock %}