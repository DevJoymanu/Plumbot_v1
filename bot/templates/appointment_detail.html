{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1>
        <i class="fas fa-user"></i>
        <span class="header-text">
            {% if appointment.customer_name %}
            {{ appointment.customer_name }}
            {% else %}
            Appointment #{{ appointment.pk }}
            {% endif %}
        </span>

        <!-- Appointment type indicator -->
        {% if appointment.appointment_type == 'job_appointment' %}
        <span class="appointment-type-badge job">Job</span>
        {% else %}
        <span class="appointment-type-badge site-visit">Site Visit</span>
        {% endif %}
    </h1>
    <p>Manage this customer appointment</p>
</div>

<!-- Messages -->
{% if messages %}
<div class="messages-container">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Job Scheduling Actions Panel -->
{% if appointment.appointment_type == 'site_visit' %}
<div class="job-scheduling-panel">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-calendar-plus"></i> Job Scheduling</h3>
        </div>
        <div class="card-body">
            {% if not appointment.site_visit_completed %}
            <div class="scheduling-status pending">
                <i class="fas fa-clock"></i>
                <div class="status-content">
                    <p>Site visit must be completed before scheduling job appointment</p>
                    <a href="{% url 'complete_site_visit' appointment.pk %}" class="btn btn-primary">
                        <i class="fas fa-clipboard-check"></i> Complete Site Visit
                    </a>
                </div>
            </div>

            {% elif appointment.can_schedule_job %}
            <div class="scheduling-status ready">
                <i class="fas fa-check-circle"></i>
                <div class="status-content">
                    <p>Site visit completed. Ready to schedule job appointment.</p>
                    <div class="completion-details">
                        <p><strong>Completed:</strong> {{ appointment.site_visit_completed_at|date:"M d, Y H:i" }}</p>
                        {% if appointment.site_visit_notes %}
                        <p><strong>Notes:</strong> {{ appointment.site_visit_notes|truncatewords:15 }}</p>
                        {% endif %}
                    </div>
                    <a href="{% url 'schedule_job' appointment.pk %}" class="btn btn-success">
                        <i class="fas fa-calendar-plus"></i> Schedule Job
                    </a>
                </div>
            </div>

            {% elif appointment.job_status == 'scheduled' %}
            <div class="scheduling-status scheduled">
                <i class="fas fa-calendar-check"></i>
                <div class="status-content">
                    <p>Job appointment has been scheduled</p>
                    <div class="job-links">
                        {% for job in appointment.get_job_appointments %}
                        <a href="{% url 'appointment_detail' job.pk %}" class="btn btn-primary">
                            <i class="fas fa-eye"></i> View Job
                        </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Related Job Appointments -->
{% elif appointment.get_job_appointments.exists %}
<div class="related-jobs-panel">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-hard-hat"></i> Related Jobs</h3>
        </div>
        <div class="card-body">
            <div class="jobs-list">
                {% for job in appointment.get_job_appointments %}
                <div class="job-summary">
                    <div class="job-info">
                        <h4>Job #{{ job.id }}</h4>
                        <p><i class="fas fa-calendar"></i> {{ job.job_scheduled_datetime|date:"M d, Y H:i" }}</p>
                        <p><i class="fas fa-clock"></i> {{ job.job_duration_hours }} hours</p>
                        <span class="status-badge status-{{ job.job_status }}">{{ job.get_job_status_display }}</span>
                    </div>
                    <div class="job-actions">
                        <a href="{% url 'appointment_detail' job.pk %}" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Job Details (if job appointment) -->
{% if appointment.appointment_type == 'job_appointment' %}
<div class="job-details-panel">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-wrench"></i> Job Details</h3>
        </div>
        <div class="card-body">
            <div class="job-detail-grid">
                <div class="job-info-section">
                    <h4>Schedule Information</h4>
                    <p><strong>Scheduled:</strong> {{ appointment.job_scheduled_datetime|date:"M d, Y H:i" }}</p>
                    <p><strong>Duration:</strong> {{ appointment.job_duration_hours }} hours</p>
                    <p><strong>Status:</strong>
                        <span class="status-badge status-{{ appointment.job_status }}">
                            {{ appointment.get_job_status_display }}
                        </span>
                    </p>
                    <p><strong>Plumber:</strong> {{ appointment.assigned_plumber.get_full_name|default:"Unassigned" }}</p>

                    {% if appointment.job_completed_at %}
                    <p><strong>Completed:</strong> {{ appointment.job_completed_at|date:"M d, Y H:i" }}</p>
                    {% endif %}
                </div>

                {% if appointment.job_description or appointment.job_materials_needed %}
                <div class="job-work-section">
                    {% if appointment.job_description %}
                    <h4>Work Description</h4>
                    <p>{{ appointment.job_description|linebreaks }}</p>
                    {% endif %}

                    {% if appointment.job_materials_needed %}
                    <h4>Materials Needed</h4>
                    <p>{{ appointment.job_materials_needed|linebreaks }}</p>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Job Actions -->
            <div class="job-actions">
                {% if appointment.job_status == 'scheduled' %}
                <button onclick="updateJobStatus({{ appointment.pk }}, 'in_progress')" class="btn btn-warning">
                    <i class="fas fa-play"></i> Start Job
                </button>
                <a href="{% url 'reschedule_job' appointment.pk %}" class="btn btn-secondary">
                    <i class="fas fa-calendar-alt"></i> Reschedule
                </a>
                {% elif appointment.job_status == 'in_progress' %}
                <button onclick="updateJobStatus({{ appointment.pk }}, 'completed')" class="btn btn-success">
                    <i class="fas fa-check"></i> Complete
                </button>
                {% endif %}

                {% if appointment.job_status in 'scheduled,in_progress' %}
                <button onclick="updateJobStatus({{ appointment.pk }}, 'cancelled')" class="btn btn-danger">
                    <i class="fas fa-times"></i> Cancel
                </button>
                {% endif %}

                {% if appointment.parent_site_visit %}
                <a href="{% url 'appointment_detail' appointment.parent_site_visit.pk %}" class="btn btn-outline-primary">
                    <i class="fas fa-eye"></i> View Site Visit
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Documents -->
{% if has_documents %}
<div class="document-access-panel">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-file-alt"></i> Documents</h3>
        </div>
        <div class="card-body">
            <div class="document-summary">
                <div>
                    <i class="fas fa-file-pdf"></i>
                    <span>{{ document_count }} document(s)</span>
                </div>
                <a href="{% url 'appointment_documents' appointment.pk %}" class="btn btn-primary">
                    <i class="fas fa-eye"></i> View
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Quotations -->
<div class="quotation-section">
    <div class="card">
        <div class="card-header">
            <h3><i class="fas fa-file-invoice-dollar"></i> Quotations</h3>
            <div style="display: flex; gap: 10px;">
                <a href="{% url 'create_quotation' appointment.pk %}" class="btn btn-primary">
                    <i class="fas fa-plus"></i> New Quotation
                </a>

                <!-- Template Dropdown -->
                <div class="dropdown" style="position: relative;">
                    <button class="btn btn-success" onclick="toggleTemplateDropdown()" id="templateDropdownBtn">
                        <i class="fas fa-file-invoice"></i> From Template
                        <i class="fas fa-chevron-down" style="margin-left: 5px; font-size: 0.8em;"></i>
                    </button>
                    <div id="templateDropdown"
                        style="display: none; position: absolute; top: 100%; right: 0; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 250px; max-height: 400px; overflow-y: auto; margin-top: 5px; z-index: 1000;">
                        <div style="padding: 10px; border-bottom: 1px solid #eee;">
                            <input type="text" id="quickTemplateSearch" placeholder="Search templates..."
                                style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 5px;"
                                oninput="quickSearchTemplates()">
                        </div>
                        <div id="quickTemplateList" style="padding: 5px;">
                            <!-- Templates loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-body">
            {% if appointment.quotations.exists %}
            <div class="quotations-list">
                {% for quote in appointment.quotations.all %}
                <div class="quotation-item status-{{ quote.status|default:'draft' }}">
                    <div class="quotation-header">
                        <h4>Quote #{{ quote.quotation_number|default:quote.id }}</h4>
                        <span class="status-badge status-{{ quote.status|default:'draft' }}">
                            {{ quote.get_status_display }}
                        </span>
                    </div>
                    <div class="quotation-details">
                        <p><strong>Total:</strong> R{{ quote.total_amount|default:"0.00" }}</p>
                        <p><strong>Created:</strong> {{ quote.created_at|date:"M d, Y H:i" }}</p>
                        {% if quote.sent_via_whatsapp and quote.sent_at %}
                        <p><strong>Sent:</strong> {{ quote.sent_at|date:"M d, Y H:i" }}</p>
                        {% endif %}
                    </div>
                    <div class="quotation-actions">
                        <a href="{% url 'view_quotation' quote.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> View
                        </a>
                        {% if quote.status == 'draft' %}
                        <a href="{% url 'edit_quotation' quote.id %}" class="btn btn-sm btn-outline-secondary">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <a href="{% url 'send_quotation' quote.id %}" class="btn btn-sm btn-success">
                            <i class="fab fa-whatsapp"></i> Send
                        </a>
                        {% elif quote.status == 'sent' %}
                        <a href="{% url 'send_quotation' quote.id %}" class="btn btn-sm btn-success">
                            <i class="fab fa-whatsapp"></i> Resend
                        </a>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="empty-state">
                <i class="fas fa-file-invoice-dollar fa-3x"></i>
                <p>No quotations yet</p>
                <a href="{% url 'create_quotation' appointment.pk %}" class="btn btn-primary mt-2">
                    <i class="fas fa-plus"></i> Create Quotation
                </a>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<div class="dashboard-grid">
    <!-- Appointment Details -->
    <div class="card">
        <h2><i class="fas fa-info-circle"></i> Details</h2>

        <div class="form-group">
            <label>Document Status</label>
            <div class="document-status">
                {% if has_documents %}
                <span class="status-badge status-available">
                    <i class="fas fa-check-circle"></i>
                    {{ document_count }} document(s)
                </span>
                {% else %}
                <span class="status-badge status-unavailable">
                    <i class="fas fa-times-circle"></i>
                    No documents
                </span>
                {% endif %}
            </div>
        </div>

        <form method="post">
            {% csrf_token %}
            <div class="form-group">
                <label>Status</label>
                <div class="appointment-status status-{{ appointment.status|default:'pending' }}">
                    {{ appointment.get_status_display }}
                </div>
            </div>

            <div class="form-group">
                <label for="customer_name">Customer Name</label>
                <input type="text" id="customer_name" name="customer_name"
                    value="{{ appointment.customer_name|default:'' }}" class="form-control">
            </div>

            <div class="form-group">
                <label for="phone_number">Phone Number</label>
                <input type="text" id="phone_number" name="phone_number"
                    value="{{ appointment.phone_number|default:'' }}" class="form-control" readonly>
            </div>

            <div class="form-group">
                <label for="project_type">Service Type</label>
                <input type="text" id="project_type" name="project_type"
                    value="{{ appointment.project_type|default:'' }}" class="form-control">
            </div>

            <div class="form-group">
                <label for="property_type">Property Type</label>
                <select id="property_type" name="property_type" class="form-control">
                    {% for value, display in appointment.PROPERTY_TYPE_CHOICES %}
                    <option value="{{ value }}" {% if appointment.property_type == value %}selected{% endif %}>
                        {{ display }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label for="customer_area">Area</label>
                <input type="text" id="customer_area" name="customer_area"
                    value="{{ appointment.customer_area|default:'' }}" class="form-control">
            </div>

            <div class="form-group">
                <label for="timeline">Timeline</label>
                <input type="text" id="timeline" name="timeline" value="{{ appointment.timeline|default:'' }}"
                    class="form-control">
            </div>

            {% if appointment.appointment_type == 'job_appointment' %}
            <div class="form-group">
                <label for="job_scheduled_datetime">Job Date/Time</label>
                <input type="datetime-local" id="job_scheduled_datetime" name="job_scheduled_datetime"
                    value="{{ appointment.job_scheduled_datetime|date:'Y-m-d\TH:i' }}" class="form-control">
            </div>
            {% else %}
            <div class="form-group">
                <label for="scheduled_datetime">Site Visit Date/Time</label>
                <input type="datetime-local" id="scheduled_datetime" name="scheduled_datetime"
                    value="{{ appointment.scheduled_datetime|date:'Y-m-d\TH:i' }}" class="form-control">
            </div>
            {% endif %}

            <div class="actions">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                {% if appointment.status == 'pending' %}
                <a href="{% url 'confirm_appointment' appointment.pk %}" class="btn btn-success">
                    <i class="fas fa-check"></i> Confirm
                </a>
                {% endif %}
                {% if appointment.status != 'cancelled' %}
                <a href="{% url 'cancel_appointment' appointment.pk %}" class="btn btn-danger">
                    <i class="fas fa-times"></i> Cancel
                </a>
                {% endif %}
            </div>
        </form>
    </div>

    <!-- Conversation History Card -->
    <div class="card">
        <h2><i class="fas fa-comments"></i> Conversation</h2>

        <!-- Follow-up Status Bar -->
        <div class="followup-status-bar">
            <div class="status-item">
                <label>Last Contact:</label>
                <span>{{ appointment.last_customer_response|date:"M d, H:i"|default:"Never" }}</span>
            </div>
            <div class="status-item">
                <label>Follow-up Stage:</label>
                <span class="badge badge-{{ appointment.followup_stage }}">
                    {{ appointment.get_followup_stage_display }}
                </span>
            </div>
            <div class="status-item">
                <label>Auto Follow-ups:</label>
                <span>{{ appointment.automatic_followup_count|default:0 }}</span>
            </div>
            <div class="status-item">
                <label>Manual Follow-ups:</label>
                <span>{{ appointment.manual_followup_count|default:0 }}</span>
            </div>

            {% if appointment.manual_followup_paused %}
            <div class="status-item paused">
                <i class="fas fa-pause-circle"></i>
                <span>Auto follow-ups paused until {{ appointment.manual_followup_paused_until|date:"M d, H:i" }}</span>
            </div>
            {% endif %}
        </div>
    
    

        <div class="conversation-history">
            {% for message in conversation_history %}
            <div class="message {% if message.role == 'user' %}user{% else %}assistant{% endif %}">
                <div class="message-header">
                    {% if message.role == 'user' %}
                    Customer
                    {% else %}
                    Bot
                    {% endif %}
                    {% if message.timestamp %}
                    <small>{{ message.timestamp|date:"M d, H:i" }}</small>
                    {% endif %}
                </div>
                <p>{{ message.content|default:"(no content)" }}</p>
            </div>
            {% empty %}
            <div class="empty-state">
                <i class="fas fa-comment-slash"></i>
                <p>No conversation history</p>
            </div>
            {% endfor %}


        <!-- Manual Follow-up Controls -->
        <div class="followup-controls">
            <!-- Pause/Resume Automatic Follow-ups -->
            <div class="auto-followup-toggle">
                {% if appointment.manual_followup_paused %}
                <form method="post" action="{% url 'resume_auto_followup' appointment.pk %}" style="display: inline;">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success btn-sm">
                        <i class="fas fa-play"></i> Resume Auto Follow-ups
                    </button>
                </form>
                {% else %}
                <button onclick="showPauseModal()" class="btn btn-warning btn-sm">
                    <i class="fas fa-pause"></i> Pause Auto Follow-ups
                </button>
                {% endif %}
            </div>

            <!-- Quick Message Templates -->
            <div class="quick-templates">
                <button onclick="insertTemplate('greeting')" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-smile"></i> Greeting
                </button>
                <button onclick="insertTemplate('check_in')" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-check"></i> Check-in
                </button>
                <button onclick="insertTemplate('offer')" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-gift"></i> Special Offer
                </button>
                <button onclick="insertTemplate('reminder')" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-bell"></i> Reminder
                </button>
            </div>
        </div>

        <!-- Manual Follow-up Form -->
        <form method="post" class="followup-form" id="followupForm">
            {% csrf_token %}
            <div class="form-group">
                <label for="followup_message">
                    <i class="fas fa-paper-plane"></i> Send Manual Follow-up
                    <span class="label-hint">(This will pause automatic follow-ups for 48 hours)</span>
                </label>
                <textarea id="followup_message" name="message" class="form-control" rows="3"
                    placeholder="Type your message here... Use {name} to personalize with customer name"
                    required></textarea>
                <div class="char-counter">
                    <span id="charCount">0</span> / 1000 characters
                </div>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn btn-primary" id="sendMessageBtn">
                    <i class="fas fa-paper-plane"></i> Send Manual Follow-up
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearMessage()">
                    <i class="fas fa-times"></i> Clear
                </button>
            </div>
            <div id="messageStatus" style="margin-top: 10px; display: none;"></div>
        </form>
    </div>
</div>

<!-- Pause Auto Follow-up Modal -->
<div id="pauseModal" class="modal" style="display: none;">
    <div class="modal-content">
        <h3>Pause Automatic Follow-ups</h3>
        <p>How long would you like to pause automatic follow-ups for this lead?</p>
        <form method="post" action="{% url 'pause_auto_followup' appointment.pk %}">
            {% csrf_token %}
            <div class="form-group">
                <label>
                    <input type="radio" name="pause_duration" value="24" checked>
                    24 hours (1 day)
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="radio" name="pause_duration" value="48">
                    48 hours (2 days)
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="radio" name="pause_duration" value="168">
                    1 week
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="radio" name="pause_duration" value="720">
                    1 month
                </label>
            </div>
            <div class="form-group">
                <label>
                    <input type="radio" name="pause_duration" value="permanent">
                    Permanently (until manually resumed)
                </label>
            </div>
            <div class="modal-actions">
                <button type="submit" class="btn btn-warning">
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button type="button" class="btn btn-secondary" onclick="hidePauseModal()">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Message templates
    const messageTemplates = {
        greeting: `Hi {name},\n\nI hope this message finds you well! I wanted to personally follow up on your plumbing project.\n\nIs there anything I can help clarify or any questions you have?\n\nBest regards,\n{your_name}\nHomebase Plumbers`,
        check_in: `Hi {name},\n\nJust checking in to see if you're still interested in moving forward with your plumbing project.\n\nWe have availability this week and would love to help!\n\nLet me know if you'd like to schedule a consultation.\n\nBest,\n{your_name}`,
        offer: `Hi {name},\n\nI wanted to reach out with a special offer for you!\n\nThis month, we're offering 10% off all bathroom renovations. Your project would be perfect for this.\n\nWould you like to discuss this further?\n\nBest regards,\n{your_name}\nHomebase Plumbers`,
        reminder: `Hi {name},\n\nI noticed we haven't heard back from you regarding your plumbing project.\n\nNo pressure at all - just wanted to remind you that we're here whenever you're ready!\n\nFeel free to reach out anytime.\n\nBest,\n{your_name}`
    };

    // Insert template into message box
    function insertTemplate(templateName) {
        const template = messageTemplates[templateName];
        if (template) {
            const customerName = '{{ appointment.customer_name|default:"there" }}';
            const yourName = '{{ request.user.get_full_name|default:request.user.username }}';

            const personalizedMessage = template
                .replace(/{name}/g, customerName)
                .replace(/{your_name}/g, yourName);

            document.getElementById('followup_message').value = personalizedMessage;
            updateCharCount();
        }
    }

    // Clear message
    function clearMessage() {
        document.getElementById('followup_message').value = '';
        updateCharCount();
    }

    // Character counter
    function updateCharCount() {
        const message = document.getElementById('followup_message').value;
        document.getElementById('charCount').textContent = message.length;
    }

    document.getElementById('followup_message').addEventListener('input', updateCharCount);

    // Pause modal
    function showPauseModal() {
        document.getElementById('pauseModal').style.display = 'flex';
    }

    function hidePauseModal() {
        document.getElementById('pauseModal').style.display = 'none';
    }

    // Handle manual follow-up form submission
    document.getElementById('followupForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const form = this;
        const messageText = document.getElementById('followup_message').value.trim();
        const sendBtn = document.getElementById('sendMessageBtn');
        const statusDiv = document.getElementById('messageStatus');

        if (!messageText) {
            alert('Please enter a message');
            return;
        }

        // Confirm that this will pause automatic follow-ups
        if (!confirm('Sending a manual follow-up will pause automatic follow-ups for 48 hours. Continue?')) {
            return;
        }

        // Show loading state
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending Manual Follow-up...';
        statusDiv.style.display = 'none';

        // Send the message
        fetch('{% url "send_followup" appointment.pk %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: new URLSearchParams({
                    'message': messageText
                })
            })
            .then(response => {
                if (response.ok) {
                    return response.text();
                }
                throw new Error('Network response was not ok');
            })
            .then(data => {
                // Success
                statusDiv.innerHTML = '<div class="alert alert-success">✅ Manual follow-up sent! Automatic follow-ups paused for 48 hours.</div>';
                statusDiv.style.display = 'block';
                document.getElementById('followup_message').value = '';
                updateCharCount();

                // Reload page after 1.5 seconds
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            })
            .catch(error => {
                // Error
                console.error('Error:', error);
                statusDiv.innerHTML = '<div class="alert alert-error">❌ Failed to send message. Please try again.</div>';
                statusDiv.style.display = 'block';
            })
            .finally(() => {
                // Reset button
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send Manual Follow-up';
            });
    });

    function updateJobStatus(jobId, newStatus) {
        if (confirm(`Change job status to ${newStatus.replace('_', ' ')}?`)) {
            fetch(`/jobs/${jobId}/update-status/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: `status=${newStatus}`
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error);
                });
        }
    }

    // Quick template dropdown
    let quickTemplates = [];

    async function toggleTemplateDropdown() {
        const dropdown = document.getElementById('templateDropdown');

        if (dropdown.style.display === 'none') {
            dropdown.style.display = 'block';
            await loadQuickTemplates();
        } else {
            dropdown.style.display = 'none';
        }
    }

    async function loadQuickTemplates() {
        const listEl = document.getElementById('quickTemplateList');
        listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #666;"><i class="fas fa-spinner fa-spin"></i></div>';

        try {
            const response = await fetch('/api/quotation-templates/?active_only=true');
            const data = await response.json();

            if (data.success && data.templates) {
                quickTemplates = data.templates;
                displayQuickTemplates(quickTemplates);
            }
        } catch (error) {
            console.error('Error loading templates:', error);
            listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">Failed to load</div>';
        }
    }

    function displayQuickTemplates(templates) {
        const listEl = document.getElementById('quickTemplateList');

        if (templates.length === 0) {
            listEl.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No templates found</div>';
            return;
        }

        listEl.innerHTML = templates.map(t => `
            <a href="/templates/${t.id}/use/{{ appointment.pk }}/"
                style="display: block; padding: 12px; text-decoration: none; color: #333; border-bottom: 1px solid #f0f0f0;"
                onmouseover="this.style.background='#f8f9fa'"
                onmouseout="this.style.background='white'">
                <div style="font-weight: 600; margin-bottom: 4px;">${t.name}</div>
                <div style="font-size: 0.85em; color: #666;">
                    ${t.items_count} items • R${t.estimated_cost.toFixed(2)}
                </div>
            </a>
        `).join('');
    }

    function quickSearchTemplates() {
        const search = document.getElementById('quickTemplateSearch').value.toLowerCase();
        const filtered = quickTemplates.filter(t =>
            t.name.toLowerCase().includes(search) ||
            (t.description && t.description.toLowerCase().includes(search))
        );
        displayQuickTemplates(filtered);
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        const dropdown = document.getElementById('templateDropdown');
        const btn = document.getElementById('templateDropdownBtn');

        if (dropdown && btn && !dropdown.contains(e.target) && !btn.contains(e.target)) {
            dropdown.style.display = 'none';
        }
    });
</script>

<!-- Combined CSS from both versions -->
<style>
    /* Follow-up specific styles */
    .followup-status-bar {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 15px;
        border-left: 4px solid #007bff;
    }

    .status-item {
        display: flex;
        flex-direction: column;
        gap: 3px;
    }

    .status-item label {
        font-size: 0.75rem;
        color: #666;
        font-weight: 600;
        text-transform: uppercase;
    }

    .status-item span {
        font-size: 0.9rem;
        color: #333;
    }

    .status-item.paused {
        color: #856404;
        background: #fff3cd;
        padding: 8px;
        border-radius: 4px;
    }

    .badge {
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
    }

    .badge-none { background: #e9ecef; color: #495057; }
    .badge-day_1 { background: #fff3cd; color: #856404; }
    .badge-day_3 { background: #cce5ff; color: #004085; }
    .badge-week_1 { background: #d1ecf1; color: #0c5460; }
    .badge-week_2 { background: #f8d7da; color: #721c24; }
    .badge-month_1 { background: #e2e3e5; color: #383d41; }
    .badge-completed { background: #d4edda; color: #155724; }
    .badge-responded { background: #d1f2eb; color: #00695c; }

    .followup-badge {
        font-size: 0.7rem;
        padding: 2px 6px;
        border-radius: 8px;
        margin-left: 8px;
    }

    .followup-badge.automatic {
        background: #e3f2fd;
        color: #1976d2;
    }

    .followup-badge.manual {
        background: #fff3e0;
        color: #f57c00;
    }

    .followup-badge.bulk {
        background: #f3e5f5;
        color: #7b1fa2;
    }

    .followup-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        margin-bottom: 15px;
    }

    .quick-templates {
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .label-hint {
        font-size: 0.75rem;
        color: #666;
        font-weight: normal;
        font-style: italic;
    }

    .char-counter {
        text-align: right;
        font-size: 0.75rem;
        color: #666;
        margin-top: 5px;
    }

    .form-actions {
        display: flex;
        gap: 8px;
    }

    .modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .modal-content h3 {
        margin-top: 0;
        margin-bottom: 15px;
    }

    .modal-content .form-group {
        margin-bottom: 12px;
    }

    .modal-content label {
        display: block;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .modal-content label:hover {
        background: #f8f9fa;
        border-color: #007bff;
    }

    .modal-content input[type="radio"] {
        margin-right: 8px;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        margin-top: 20px;
    }

    /* Base Styles */
    * {
        box-sizing: border-box;
    }

    .header h1 {
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        gap: 10px;
        font-size: clamp(1.5rem, 4vw, 2rem);
    }

    .header-text {
        word-break: break-word;
    }

    /* Messages */
    .messages-container {
        margin-bottom: 20px;
    }

    .alert {
        padding: 12px 15px;
        border-radius: 5px;
        margin-bottom: 10px;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    /* Appointment Type Badges */
    .appointment-type-badge {
        font-size: 0.6em;
        padding: 4px 8px;
        border-radius: 12px;
        font-weight: bold;
        white-space: nowrap;
    }

    .appointment-type-badge.site-visit {
        background: #e3f2fd;
        color: #1976d2;
    }

    .appointment-type-badge.job {
        background: #fff3e0;
        color: #f57c00;
    }

    /* Cards */
    .card {
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
        overflow: hidden;
    }

    .card-header {
        background: #f8f9fa;
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .card-header h3 {
        margin: 0;
        font-size: 1.1rem;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .card-body {
        padding: 15px;
    }

    /* Scheduling Status */
    .scheduling-status {
        display: flex;
        gap: 15px;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .scheduling-status i {
        font-size: 1.5em;
        flex-shrink: 0;
        margin-top: 2px;
    }

    .status-content {
        flex: 1;
    }

    .status-content p {
        margin: 0 0 10px 0;
        font-weight: 500;
    }

    .scheduling-status.pending {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
    }

    .scheduling-status.ready {
        background: #d4edda;
        border: 1px solid #c3e6cb;
        color: #155724;
    }

    .scheduling-status.scheduled {
        background: #cce5ff;
        border: 1px solid #b3d9ff;
        color: #004085;
    }

    .completion-details {
        font-size: 0.9em;
        margin: 8px 0;
        color: #666;
    }

    /* Job Details */
    .job-detail-grid {
        display: grid;
        gap: 15px;
        margin-bottom: 20px;
    }

    .job-info-section,
    .job-work-section {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #007bff;
    }

    .job-info-section h4,
    .job-work-section h4 {
        margin: 0 0 10px 0;
        color: #333;
        font-size: 1rem;
    }

    .job-info-section p,
    .job-work-section p {
        margin: 5px 0;
        font-size: 0.9rem;
    }

    /* Job Summary */
    .job-summary {
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
        border-left: 4px solid #28a745;
        margin-bottom: 10px;
    }

    .job-summary h4 {
        margin: 0 0 8px 0;
        color: #333;
        font-size: 1rem;
    }

    .job-summary p {
        margin: 4px 0;
        font-size: 0.85rem;
        color: #666;
    }

    .job-summary p i {
        margin-right: 5px;
        width: 12px;
    }

    .job-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 15px;
    }

    /* Status Badges */
    .status-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75em;
        font-weight: bold;
        display: inline-block;
        white-space: nowrap;
    }

    .status-pending_schedule {
        background: #ffc107;
        color: #212529;
    }

    .status-scheduled {
        background: #17a2b8;
        color: white;
    }

    .status-in_progress {
        background: #fd7e14;
        color: white;
    }

    .status-completed {
        background: #28a745;
        color: white;
    }

    .status-cancelled {
        background: #dc3545;
        color: white;
    }

    .status-available {
        background: #d4edda;
        color: #155724;
    }

    .status-unavailable {
        background: #f8d7da;
        color: #721c24;
    }

    /* Documents */
    .document-summary {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
    }

    .document-summary div {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    /* Quotations */
    .quotation-item {
        border: 1px solid #ddd;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 10px;
        background: #f9f9f9;
    }

    .quotation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
    }

    .quotation-header h4 {
        margin: 0;
        font-size: 1rem;
    }

    .quotation-details {
        margin-bottom: 10px;
        font-size: 0.9rem;
    }

    .quotation-details p {
        margin: 4px 0;
    }

    .quotation-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
    }

    .status-accepted {
        border-left: 4px solid #28a745;
    }

    .status-sent {
        border-left: 4px solid #17a2b8;
    }

    .status-draft {
        border-left: 4px solid #6c757d;
    }

    /* Dashboard Grid */
    .dashboard-grid {
        display: grid;
        gap: 20px;
    }

    /* Forms */
    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        font-size: 0.9rem;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    textarea.form-control {
        resize: vertical;
        min-height: 80px;
    }

    /* Conversation */
    .conversation-history {
        max-height: 400px;
        overflow-y: auto;
        margin-bottom: 15px;
        padding-right: 5px;
    }

    .message {
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
        font-size: 0.9rem;
    }

    .message.user {
        background: #e3f2fd;
        margin-left: 20px;
    }

    .message.assistant {
        background: #f5f5f5;
        margin-right: 20px;
    }

    .message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
        font-weight: 600;
        font-size: 0.85rem;
        flex-wrap: wrap;
    }

    .message-header small {
        font-weight: normal;
        color: #666;
    }

    .message p {
        margin: 0;
        word-wrap: break-word;
    }

    .followup-form {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #dee2e6;
    }

    /* Actions */
    .actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 20px;
    }

    /* Buttons */
    .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        padding: 10px 16px;
        border: none;
        border-radius: 5px;
        font-size: 0.9rem;
        font-weight: 500;
        text-decoration: none;
        cursor: pointer;
        transition: all 0.2s;
        white-space: nowrap;
    }

    .btn:hover {
        text-decoration: none;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .btn:active {
        transform: translateY(0);
    }

    .btn-primary {
        background: #007bff;
        color: white;
    }

    .btn-primary:hover {
        background: #0056b3;
        color: white;
    }

    .btn-success {
        background: #28a745;
        color: white;
    }

    .btn-success:hover {
        background: #218838;
        color: white;
    }

    .btn-warning {
        background: #ffc107;
        color: #212529;
    }

    .btn-warning:hover {
        background: #e0a800;
    }

    .btn-danger {
        background: #dc3545;
        color: white;
    }

    .btn-danger:hover {
        background: #c82333;
        color: white;
    }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background: #5a6268;
        color: white;
    }

    .btn-outline-primary {
        background: transparent;
        color: #007bff;
        border: 1px solid #007bff;
    }

    .btn-outline-primary:hover {
        background: #007bff;
        color: white;
    }

    .btn-outline-secondary {
        background: transparent;
        color: #6c757d;
        border: 1px solid #6c757d;
    }

    .btn-outline-secondary:hover {
        background: #6c757d;
        color: white;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 0.8rem;
    }

    .btn i {
        font-size: 0.9em;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .empty-state i {
        margin-bottom: 15px;
        color: #dee2e6;
    }

    .empty-state p {
        margin: 10px 0;
    }

    .mt-2 {
        margin-top: 10px;
    }

    /* Tablet & Desktop */
    @media (min-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr 1fr;
        }

        .job-detail-grid {
            grid-template-columns: 1fr 1fr;
        }

        .header h1 {
            font-size: 2rem;
        }

        .appointment-type-badge {
            font-size: 0.7em;
        }

        .conversation-history {
            max-height: 450px;
        }
    }

    /* Mobile Optimizations */
    @media (max-width: 767px) {
        .header {
            padding: 15px;
        }

        .header h1 {
            font-size: 1.5rem;
        }

        .header p {
            font-size: 0.9rem;
        }

        .card-body {
            padding: 12px;
        }

        .scheduling-status {
            flex-direction: column;
            gap: 10px;
        }

        .scheduling-status i {
            font-size: 1.2em;
        }

        .job-summary {
            padding: 12px;
        }

        .job-actions {
            width: 100%;
        }

        .job-actions .btn {
            flex: 1;
            min-width: 0;
        }

        .actions {
            flex-direction: column;
        }

        .actions .btn {
            width: 100%;
        }

        .quotation-actions {
            flex-direction: column;
        }

        .quotation-actions .btn {
            width: 100%;
        }

        .document-summary {
            flex-direction: column;
            align-items: flex-start;
        }

        .document-summary .btn {
            width: 100%;
        }

        .message.user {
            margin-left: 10px;
        }

        .message.assistant {
            margin-right: 10px;
        }

        .form-control {
            font-size: 16px;
            padding: 12px;
        }

        .btn {
            padding: 12px 16px;
            font-size: 1rem;
        }

        .btn-sm {
            padding: 8px 12px;
            font-size: 0.85rem;
        }

        .followup-status-bar {
            flex-direction: column;
        }
        
        .followup-controls {
            flex-direction: column;
            align-items: stretch;
        }
        
        .quick-templates {
            justify-content: center;
        }
        
        .form-actions {
            flex-direction: column;
        }
        
        .form-actions .btn {
            width: 100%;
        }
    }

    /* Very small screens */
    @media (max-width: 400px) {
        .quotation-header {
            flex-direction: column;
            align-items: flex-start;
        }

        .job-summary {
            font-size: 0.9rem;
        }

        .card-header h3 {
            font-size: 1rem;
        }
        
        .card-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 10px;
        }
    }

    /* Accessibility */
    .btn:focus,
    .form-control:focus {
        outline: 2px solid #007bff;
        outline-offset: 2px;
    }

    /* Loading state for save button */
    .btn-primary:disabled {
        background: #6c757d;
        cursor: not-allowed;
        opacity: 0.6;
    }

    /* Smooth scrolling for conversation */
    .conversation-history {
        scroll-behavior: smooth;
    }

    /* Better touch targets */
    @media (hover: none) and (pointer: coarse) {
        .btn {
            min-height: 44px;
        }

        .btn-sm {
            min-height: 36px;
        }
    }

    /* Print styles */
    @media print {
        .btn,
        .actions,
        .followup-form,
        .job-actions,
        .followup-controls {
            display: none;
        }

        .card {
            break-inside: avoid;
            box-shadow: none;
            border: 1px solid #ddd;
        }

        .dashboard-grid {
            display: block;
        }

        .conversation-history {
            max-height: none;
        }
    }
</style>
{% endblock %}