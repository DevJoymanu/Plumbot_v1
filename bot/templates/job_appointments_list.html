{% extends "base.html" %}

{% block content %}

<!DOCTYPE html>
<html>

<head>
    <title>Job Appointments</title>
    {% load static %}
</head>

<body>
    <div class="container">
        <div class="header">
            <h1>
                <i class="fas fa-hard-hat"></i>
                Job Appointments
            </h1>
            <p>Manage scheduled plumbing jobs</p>
        </div>

        <!-- Filters -->
        <div class="card">
            <div class="card-header">
                <h3>Filter Jobs</h3>
            </div>
            <div class="card-body">
                <form method="get" class="filter-form">
                    <div class="filter-row">
                        <div class="form-group">
                            <label for="status">Status</label>
                            <select id="status" name="status" class="form-control">
                                <option value="">All statuses</option>
                                <option value="scheduled" {% if selected_status  ==  "scheduled" %}selected{% endif %}>
                                    Scheduled</option>
                                <option value="in_progress" {% if selected_status  ==  "in_progress" %}selected{% endif %}>
                                    In Progress</option>
                                <option value="completed" {% if selected_status  ==  "completed" %}selected{% endif %}>
                                    Completed</option>
                                <option value="cancelled" {% if selected_status  ==  "cancelled" %}selected{% endif %}>
                                    Cancelled</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="plumber">Plumber</label>
                            <select id="plumber" name="plumber" class="form-control">
                                <option value="">All plumbers</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-filter"></i> Filter
                            </button>
                            <a href="{% url 'job_appointments_list' %}" class="btn btn-secondary">Clear</a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Job Appointments List -->
        <div class="card">
            <div class="card-header">
                <h3>Scheduled Jobs ({{ job_appointments.count }})</h3>
            </div>
            <div class="card-body">
                {% if job_appointments %}
                <div class="jobs-list">
                    {% for job in job_appointments %}
                    <div class="job-item status-{{ job.job_status }}">
                        <div class="job-header">
                            <div class="job-title">
                                <h4>{{ job.customer_name|default:"Unknown Customer" }}</h4>
                                <span class="job-type">{{ job.project_type }}</span>
                            </div>
                            <div class="job-status">
                                <span class="status-badge status-{{ job.job_status }}">
                                    {{ job.get_job_status_display }}
                                </span>
                            </div>
                        </div>

                        <div class="job-details">
                            <div class="job-info">
                                <p><i class="fas fa-calendar"></i> {{ job.job_scheduled_datetime|date:"M d, Y" }}</p>
                                <p><i class="fas fa-clock"></i> {{ job.job_scheduled_datetime|date:"H:i" }}</p>
                                <p><i class="fas fa-map-marker-alt"></i> {{ job.customer_area }}</p>
                                <p><i class="fas fa-user"></i> {{
                                    job.assigned_plumber.get_full_name|default:"Unassigned" }}</p>
                            </div>

                            {% if job.job_description %}
                            <div class="job-description">
                                <p><strong>Work Description:</strong></p>
                                <p>{{ job.job_description|truncatewords:20 }}</p>
                            </div>
                            {% endif %}
                        </div>

                        <div class="job-actions">
                            <a href="{% url 'appointment_detail' job.pk %}" class="btn btn-sm btn-primary">
                                <i class="fas fa-eye"></i> View Details
                            </a>

                            {% if job.job_status   ==   'scheduled' %}
                            <button onclick="updateJobStatus({{ job.pk }}, 'in_progress')"
                                class="btn btn-sm btn-warning">
                                <i class="fas fa-play"></i> Start Job
                            </button>
                            <a href="{% url 'reschedule_job' job.pk %}" class="btn btn-sm btn-secondary">
                                <i class="fas fa-calendar-alt"></i> Reschedule
                            </a>
                            {% elif job.job_status   ==   'in_progress' %}
                            <button onclick="updateJobStatus({{ job.pk }}, 'completed')" class="btn btn-sm btn-success">
                                <i class="fas fa-check"></i> Complete Job
                            </button>
                            {% endif %}

                            {% if job.job_status   ==   'scheduled' or job.job_status   ==   'in_progress' %}
                            <button onclick="updateJobStatus({{ job.pk }}, 'cancelled')" class="btn btn-sm btn-danger">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="empty-state">
                    <i class="fas fa-hard-hat fa-3x"></i>
                    <p>No job appointments found</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        function updateJobStatus(jobId, newStatus) {
            if (confirm('Are you sure you want to change the job status to ' + newStatus.replace('_', ' ') + '?')) {
                fetch('/jobs/' + jobId + '/update-status/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: 'status=' + newStatus
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert('Error updating status: ' + data.error);
                        }
                    })
                    .catch(error => {
                        alert('Error updating status: ' + error);
                    });
            }
        }
    </script>

    <style>
        .filter-form .filter-row {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
        }

        .jobs-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .job-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 20px;
            background: #f9f9f9;
        }

        .job-item.status-scheduled {
            border-left: 4px solid #17a2b8;
        }

        .job-item.status-in_progress {
            border-left: 4px solid #ffc107;
        }

        .job-item.status-completed {
            border-left: 4px solid #28a745;
        }

        .job-item.status-cancelled {
            border-left: 4px solid #dc3545;
        }

        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .job-title h4 {
            margin: 0;
            color: #333;
        }

        .job-type {
            font-size: 0.9em;
            color: #666;
            text-transform: capitalize;
        }

        .job-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 15px;
        }

        .job-info p {
            margin: 5px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .job-description {
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid #eee;
        }

        .job-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 0.8em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-scheduled {
            background: #17a2b8;
            color: white;
        }

        .status-in_progress {
            background: #ffc107;
            color: #212529;
        }

        .status-completed {
            background: #28a745;
            color: white;
        }

        .status-cancelled {
            background: #dc3545;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
    </style>
</body>

</html>
{% endblock %}